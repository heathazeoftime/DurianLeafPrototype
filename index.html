<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Durian Disease Monitoring — Dashboard</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
/* ========== GLOBAL THEME (Dark) ========== */
body {
    margin: 0;
    padding: 20px 0 40px;
    background: #0d1117;
    font-family: "Inter", sans-serif;
    color: #e6edf3;
    display: flex;
    flex-direction: column;
    align-items: center;
}

h1 {
    margin: 10px 0 5px;
    font-size: 28px;
    font-weight: 600;
    color: #58a6ff;
}

.subtitle {
    font-size: 14px;
    color: #8b949e;
}

/* Layout wrapper */
.main-layout {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 20px;
    justify-content: center;
}

/* ========== CARD ========== */
.card {
    background: #161b22;
    padding: 18px 20px;
    border-radius: 14px;
    border: 1px solid #30363d;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
}

/* Live card & History card width */
.live-card {
    width: 360px;
}
.history-card {
    width: 360px;
}

/* ========== LIVE IMAGE + BBOX ========== */
#imageContainer {
    width: 320px;
    height: 240px;
    border-radius: 8px;
    position: relative;
    overflow: hidden;
    border: 1px solid #30363d;
    background: #0d1117;
}

#cameraImage {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

#bbox {
    position: absolute;
    border: 3px solid #ff4d4d;
    border-radius: 3px;
    pointer-events: none;
    transition: all 0.15s ease-in-out;
}

/* ========== INFO PANEL ========== */
#infoPanel {
    margin-top: 12px;
    line-height: 1.6em;
    font-size: 15px;
}

.labelTag {
    display: inline-block;
    background: #1f6feb;
    padding: 2px 8px;
    border-radius: 6px;
    font-weight: 600;
}

.statusBadge {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-left: 6px;
}

#statusConnected { background: #2ea043; }
#statusWaiting   { background: #d29922; }

.hidden { display: none; }

/* ========== HISTORY LIST ========== */
#historyList {
    margin-top: 8px;
    max-height: 320px;
    overflow-y: auto;
    padding-right: 4px;
}

.history-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
}

.history-item {
    display: flex;
    align-items: center;
    padding: 6px;
    margin-bottom: 6px;
    border-radius: 8px;
    border: 1px solid #30363d;
    background: #0d1117;
    cursor: pointer;
    transition: background 0.15s ease-in-out, transform 0.05s;
}

.history-item:hover {
    background: #21262d;
    transform: translateY(-1px);
}

.history-thumb {
    width: 64px;
    height: 48px;
    border-radius: 5px;
    object-fit: cover;
    margin-right: 8px;
    border: 1px solid #30363d;
}

.history-meta {
    display: flex;
    flex-direction: column;
    font-size: 13px;
}

.history-label {
    font-weight: 600;
    color: #e6edf3;
}

.history-confidence {
    color: #8b949e;
}

.history-time {
    color: #6e7681;
    font-size: 12px;
}
</style>
</head>

<body>

<h1>Durian Disease Monitoring</h1>
<div class="subtitle">Live detection + history of captured leaves</div>

<div class="main-layout">
    <!-- ========== LIVE VIEW CARD ========== -->
    <div class="card live-card">
        <h3 style="margin-top:0; margin-bottom:8px;">Live View</h3>
        <div id="imageContainer">
            <img id="cameraImage" src="" alt="Waiting for image...">
            <div id="bbox"></div>
        </div>

        <div id="infoPanel">
            <div>
                Status:
                <span id="statusWaiting" class="statusBadge"></span>
                <span id="statusConnected" class="statusBadge hidden"></span>
            </div>

            <div style="margin-top: 8px;">
                Label: <span id="label" class="labelTag">-</span><br>
                Confidence: <span id="confidence">-</span><br>
                Last Update: <span id="timestamp">-</span>
            </div>
        </div>
    </div>

    <!-- ========== HISTORY CARD ========== -->
    <div class="card history-card">
        <div class="history-title">History (latest detections)</div>
        <div id="historyList">
            <!-- Items will be added here dynamically -->
        </div>
    </div>
</div>

<script>
// ===================
// 1. FIREBASE CONFIG
// ===================
// GANTI dengan config project-mu sendiri
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "duriandiseasemonitoring.firebaseapp.com",
    databaseURL: "https://duriandiseasemonitoring-default-rtdb.firebaseio.com",
    projectId: "duriandiseasemonitoring",
    storageBucket: "duriandiseasemonitoring.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abcdef123456"
};

firebase.initializeApp(firebaseConfig);

// Reference path
const latestRef  = firebase.database().ref("detections/latest");
const historyRef = firebase.database().ref("detections/history").limitToLast(20);

// UI elements
const imgEl    = document.getElementById("cameraImage");
const bboxEl   = document.getElementById("bbox");
const labelEl  = document.getElementById("label");
const confEl   = document.getElementById("confidence");
const timeEl   = document.getElementById("timestamp");
const statusWaiting   = document.getElementById("statusWaiting");
const statusConnected = document.getElementById("statusConnected");
const historyListEl   = document.getElementById("historyList");

// Helper → status badge
function setStatus(connected) {
    if (connected) {
        statusConnected.classList.remove("hidden");
        statusWaiting.classList.add("hidden");
    } else {
        statusWaiting.classList.remove("hidden");
        statusConnected.classList.add("hidden");
    }
}

// ============================
// 2. LISTENER: LIVE /latest
// ============================
latestRef.on("value", (snap) => {
    if (!snap.exists()) {
        console.log("Waiting for first detection...");
        setStatus(false);
        return;
    }

    const data = snap.val();
    console.log("Live update:", data);
    setStatus(true);

    if (data.image_b64) {
        imgEl.src = "data:image/jpeg;base64," + data.image_b64;
    }

    labelEl.innerText = data.label || "-";

    if (typeof data.confidence === "number") {
        confEl.innerText = (data.confidence * 100).toFixed(1) + "%";
    } else {
        confEl.innerText = "-";
    }

    timeEl.innerText = new Date().toLocaleTimeString();

    // Draw bounding box (assume koordinat dalam piksel QVGA 320x240)
    if (typeof data.x === "number") {
        bboxEl.style.left   = data.x + "px";
        bboxEl.style.top    = data.y + "px";
        bboxEl.style.width  = data.width  + "px";
        bboxEl.style.height = data.height + "px";
    }
});

<div class="card history-card">
    <div class="history-title">
        History (latest detections)
    </div>

    <!-- Tombol Clear History -->
    <button id="clearHistoryBtn"
        style="
            margin-bottom:10px;
            padding:6px 12px;
            background:#da3633;
            border:1px solid #f85149;
            color:white;
            border-radius:6px;
            cursor:pointer;
            font-weight:600;">
        Clear History
    </button>

    <div id="historyList"></div>
</div>

// ============================
// 3. LISTENER: HISTORY
// ============================
historyRef.on("value", (snap) => {
    historyListEl.innerHTML = "";

    if (!snap.exists()) {
        const emptyMsg = document.createElement("div");
        emptyMsg.className = "history-time";
        emptyMsg.innerText = "No history yet.";
        historyListEl.appendChild(emptyMsg);
        return;
    }

    // RTDB snapshot.forEach berjalan ascending by key
    snap.forEach((childSnap) => {
        const d = childSnap.val();

        // Kita fokus pada data yang punya image_b64
        if (!d.image_b64) {
            return; // skip entry tanpa gambar
        }

        const item = document.createElement("div");
        item.className = "history-item";

        const thumb = document.createElement("img");
        thumb.className = "history-thumb";
        thumb.src = "data:image/jpeg;base64," + d.image_b64;

        const meta = document.createElement("div");
        meta.className = "history-meta";

        const labelDiv = document.createElement("div");
        labelDiv.className = "history-label";
        labelDiv.innerText = d.label || "(no label)";

        const confDiv = document.createElement("div");
        confDiv.className = "history-confidence";
        if (typeof d.confidence === "number") {
            confDiv.innerText = "Conf: " + (d.confidence * 100).toFixed(1) + "%";
        } else {
            confDiv.innerText = "Conf: -";
        }

        const timeDiv = document.createElement("div");
        timeDiv.className = "history-time";
        timeDiv.innerText = "Click to preview";

        meta.appendChild(labelDiv);
        meta.appendChild(confDiv);
        meta.appendChild(timeDiv);

        item.appendChild(thumb);
        item.appendChild(meta);

        // Klik history item → tampilkan di panel Live
        item.addEventListener("click", () => {
            imgEl.src = thumb.src;

            labelEl.innerText = d.label || "-";
            if (typeof d.confidence === "number") {
                confEl.innerText = (d.confidence * 100).toFixed(1) + "%";
            } else {
                confEl.innerText = "-";
            }
            timeEl.innerText = "from history";

            if (typeof d.x === "number") {
                bboxEl.style.left   = d.x + "px";
                bboxEl.style.top    = d.y + "px"; 
                bboxEl.style.width  = d.width  + "px";
                bboxEl.style.height = d.height + "px";
            }
        });

        historyListEl.appendChild(item);
    });
});

// ============================
// 4. CLEAR HISTORY BUTTON
// ============================
document.getElementById("clearHistoryBtn").addEventListener("click", () => {
    if (!confirm("Hapus semua history?")) return;

    firebase.database().ref("detections/history")
        .remove()
        .then(() => {
            console.log("History cleared.");
            historyListEl.innerHTML = ""; // kosongkan UI
        })
        .catch(err => {
            console.error("Error clearing history:", err);
        });
});

</script>

</body>
</html>

