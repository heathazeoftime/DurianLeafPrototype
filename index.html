<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Durian Disease Monitoring â€” Dashboard</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
/* ========== GLOBAL THEME (Dark) ========== */
body {
    margin: 0;
    padding: 20px 0 40px;
    background: #0d1117;
    font-family: "Inter", sans-serif;
    color: #e6edf3;
    display: flex;
    flex-direction: column;
    align-items: center;
}

h1 {
    margin: 10px 0 5px;
    font-size: 28px;
    font-weight: 600;
    color: #58a6ff;
}

.subtitle {
    font-size: 14px;
    color: #8b949e;
}

/* Layout wrapper */
.main-layout {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 20px;
    justify-content: center;
}

/* ========== CARD ========== */
.card {
    background: #161b22;
    padding: 18px 20px;
    border-radius: 14px;
    border: 1px solid #30363d;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
}

.live-card { width: 360px; }
.history-card { width: 360px; }

/* IMAGE + BBOX */
#imageContainer {
    width: 320px;
    height: 240px;
    border-radius: 8px;
    position: relative;
    overflow: hidden;
    border: 1px solid #30363d;
    background: #0d1117;
}
#cameraImage {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
#bbox {
    position: absolute;
    border: 3px solid #ff4d4d;
    border-radius: 3px;
    pointer-events: none;
    transition: all 0.15s ease-in-out;
}

/* INFO PANEL */
#infoPanel {
    margin-top: 12px;
    line-height: 1.6em;
    font-size: 15px;
}
.labelTag {
    display: inline-block;
    background: #1f6feb;
    padding: 2px 8px;
    border-radius: 6px;
    font-weight: 600;
}
.statusBadge {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-left: 6px;
}
#statusConnected { background: #2ea043; }
#statusWaiting { background: #d29922; }
.hidden { display: none; }

/* HISTORY */
#historyList {
    margin-top: 8px;
    max-height: 320px;
    overflow-y: auto;
    padding-right: 4px;
}
.history-item {
    display: flex;
    align-items: center;
    padding: 6px;
    margin-bottom: 6px;
    border-radius: 8px;
    border: 1px solid #30363d;
    background: #0d1117;
    cursor: pointer;
    transition: background 0.15s ease-in-out, transform 0.05s;
}
.history-item:hover {
    background: #21262d;
    transform: translateY(-1px);
}
.history-thumb {
    width: 64px;
    height: 48px;
    border-radius: 5px;
    object-fit: cover;
    margin-right: 8px;
    border: 1px solid #30363d;
}
.history-meta {
    display: flex;
    flex-direction: column;
    font-size: 13px;
}
.history-label { font-weight: 600; }
.history-confidence { color: #8b949e; }
.history-time { color: #6e7681; font-size: 12px; }

#clearHistoryBtn {
    margin-bottom: 10px;
    padding: 6px 12px;
    background: #da3633;
    border: 1px solid #f85149;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
}
</style>
</head>

<body>

<h1>Durian Disease Monitoring</h1>
<div class="subtitle">Live detection + history of captured leaves</div>

<div class="main-layout">

    <!-- LIVE VIEW -->
    <div class="card live-card">
        <h3 style="margin-top:0; margin-bottom:8px;">Live View</h3>
        <div id="imageContainer">
            <img id="cameraImage" src="">
            <div id="bbox"></div>
        </div>

        <div id="infoPanel">
            <div>
                Status:
                <span id="statusWaiting" class="statusBadge"></span>
                <span id="statusConnected" class="statusBadge hidden"></span>
            </div>

            <div style="margin-top: 8px;">
                Label: <span id="label" class="labelTag">-</span><br>
                Confidence: <span id="confidence">-</span><br>
                Last Update: <span id="timestamp">-</span>
            </div>
        </div>
    </div>

    <!-- HISTORY -->
    <div class="card history-card">
        <div class="history-title">History (latest detections)</div>

        <button id="clearHistoryBtn">Clear History</button>

        <div id="historyList"></div>
    </div>

</div>

<script>
// ===================
// FIREBASE CONFIG
// ===================
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "duriandiseasemonitoring.firebaseapp.com",
    databaseURL: "https://duriandiseasemonitoring-default-rtdb.firebaseio.com",
    projectId: "duriandiseasemonitoring",
    storageBucket: "duriandiseasemonitoring.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abcdef123456"
};
firebase.initializeApp(firebaseConfig);

// Refs
const latestRef  = firebase.database().ref("detections/latest");
const historyRef = firebase.database().ref("detections/history").limitToLast(20);

// UI elements
const imgEl = document.getElementById("cameraImage");
const bboxEl = document.getElementById("bbox");
const labelEl = document.getElementById("label");
const confEl = document.getElementById("confidence");
const timeEl = document.getElementById("timestamp");
const statusWaiting = document.getElementById("statusWaiting");
const statusConnected = document.getElementById("statusConnected");
const historyListEl = document.getElementById("historyList");

// Status badge
function setStatus(ok) {
    if (ok) {
        statusConnected.classList.remove("hidden");
        statusWaiting.classList.add("hidden");
    } else {
        statusWaiting.classList.remove("hidden");
        statusConnected.classList.add("hidden");
    }
}

// LIVE LISTENER
latestRef.on("value", (snap) => {
    if (!snap.exists()) { setStatus(false); return; }

    const d = snap.val();
    setStatus(true);

    if (d.image_b64) imgEl.src = "data:image/jpeg;base64," + d.image_b64;

    labelEl.textContent = d.label || "-";
    confEl.textContent =
        typeof d.confidence === "number"
            ? (d.confidence * 100).toFixed(1) + "%"
            : "-";

    timeEl.textContent = new Date().toLocaleTimeString();

    if (typeof d.x === "number") {
        bboxEl.style.left = d.x + "px";
        bboxEl.style.top = d.y + "px";
        bboxEl.style.width = d.width + "px";
        bboxEl.style.height = d.height + "px";
    }
});

// HISTORY LISTENER
historyRef.on("value", (snap) => {
    historyListEl.innerHTML = "";

    if (!snap.exists()) {
        historyListEl.innerHTML = "<div class='history-time'>No history yet.</div>";
        return;
    }

    snap.forEach((childSnap) => {
        const d = childSnap.val();
        if (!d.image_b64) return;

        const item = document.createElement("div");
        item.className = "history-item";

        const img = document.createElement("img");
        img.className = "history-thumb";
        img.src = "data:image/jpeg;base64," + d.image_b64;

        const meta = document.createElement("div");
        meta.className = "history-meta";

        meta.innerHTML = `
            <div class="history-label">${d.label || "-"}</div>
            <div class="history-confidence">${d.confidence ? (d.confidence * 100).toFixed(1) + "%" : "-"}</div>
            <div class="history-time">Click to preview</div>
        `;

        item.appendChild(img);
        item.appendChild(meta);

        item.addEventListener("click", () => {
            imgEl.src = img.src;
            labelEl.textContent = d.label || "-";
            confEl.textContent = d.confidence ? (d.confidence * 100).toFixed(1) + "%" : "-";
            timeEl.textContent = "from history";

            if (typeof d.x === "number") {
                bboxEl.style.left = d.x + "px";
                bboxEl.style.top = d.y + "px";
                bboxEl.style.width = d.width + "px";
                bboxEl.style.height = d.height + "px";
            }
        });

        historyListEl.appendChild(item);
    });
});

// CLEAR HISTORY
document.getElementById("clearHistoryBtn").addEventListener("click", () => {
    if (!confirm("Hapus semua history?")) return;

    firebase.database().ref("detections/history")
        .remove()
        .then(() => {
            historyListEl.innerHTML = "";
            console.log("History cleared.");
        });
});
</script>

</body>
</html>
