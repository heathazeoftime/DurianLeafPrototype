<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Durian Disease Monitoring — Dashboard</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
/* GLOBAL THEME */
body {
    margin: 0;
    padding: 20px 0 40px;
    background: #0d1117;
    font-family: "Inter", sans-serif;
    color: #e6edf3;
    display: flex;
    flex-direction: column;
    align-items: center;
}
h1 { font-size: 28px; font-weight: 600; color: #58a6ff; }
.subtitle { font-size: 14px; color: #8b949e; }

.main-layout {
    display: flex;
    gap: 20px;
    margin-top: 20px;
    justify-content: center;
    flex-wrap: wrap;
}

/* CARD */
.card {
    background: #161b22;
    padding: 18px 20px;
    border-radius: 14px;
    border: 1px solid #30363d;
}

/* LIVE */
.live-card { width: 360px; }
.history-card { width: 360px; }

/* IMAGE */
#imageContainer {
    width: 320px; height: 240px;
    border-radius: 8px; border: 1px solid #30363d;
    overflow: hidden; position: relative;
}
#bbox {
    position: absolute;
    border: 3px solid #ff4d4d;
    pointer-events: none;
}

/* STATUS */
.statusBadge { width:10px; height:10px; border-radius:50%; display:inline-block; }
#statusConnected { background:#2ea043; }
#statusWaiting { background:#d29922; }
.hidden { display:none; }

/* SEVERITY */
.conf-green  { background:#238636; padding:2px 8px; border-radius:6px; }
.conf-yellow { background:#d29922; padding:2px 8px; border-radius:6px; }
.conf-red    { background:#da3633; padding:2px 8px; border-radius:6px; }

/* HISTORY */
#historyList {
    max-height: 400px;          /* <= batas tinggi box */
    overflow-y: auto;           /* <= scroll di dalam box */
    padding-right: 5px;
}

.history-item {
    display:flex; padding:6px;
    border:1px solid #30363d; border-radius:8px;
    margin-bottom:6px; cursor:pointer;
}
.history-item:hover { background:#21262d; transform:translateY(-1px); }
.history-thumb { width:64px; height:48px; object-fit:cover; margin-right:8px; }

#clearHistoryBtn, #resetPieBtn {
    background:#da3633; border:1px solid #f85149;
    padding:6px 12px; color:#fff; border-radius:6px;
    cursor:pointer; font-weight:600;
    margin-bottom: 10px;
}
</style>
</head>

<body>

<h1>Durian Disease Monitoring</h1>
<div class="subtitle">Live detection · History · Analytics</div>

<div class="main-layout">
    <!-- LIVE VIEW -->
    <div class="card live-card">
        <h3>Live View</h3>
        <div id="imageContainer">
            <img id="cameraImage" src="" style="width:100%;height:100%;object-fit:cover;">
            <div id="bbox"></div>
        </div>

        <div>
            Status:
            <span id="statusWaiting" class="statusBadge"></span>
            <span id="statusConnected" class="statusBadge hidden"></span>

            <div style="margin-top:8px;">
                Label: <span id="label">-</span><br>
                Confidence: <span id="confidence">-</span><br>
                Last Update: <span id="timestamp">-</span>
            </div>
        </div>
    </div>

    <!-- HISTORY -->
    <div class="card history-card">
        <h3>History (latest)</h3>
        <button id="clearHistoryBtn">Clear History</button>
        <div id="historyList"></div>
    </div>
</div>

<!-- CONFIDENCE vs TIME -->
<div class="card" style="width:760px; margin-top:20px;">
    <h3>Confidence vs Time</h3>
    <canvas id="confidenceChart"></canvas>
</div>

<!-- PIE CHART -->
<div class="card" style="width:480px; margin-top:20px;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">Disease Distribution</h3>
        <button id="resetPieBtn">Reset Pie</button>
    </div>
    <canvas id="pieChart" width="400" height="280"></canvas>
</div>

<script>
// FIREBASE
firebase.initializeApp({
    apiKey:"YOUR_API_KEY",
    authDomain:"duriandiseasemonitoring.firebaseapp.com",
    databaseURL:"https://duriandiseasemonitoring-default-rtdb.firebaseio.com"
});

const latestRef  = firebase.database().ref("detections/latest");
const historyRef = firebase.database().ref("detections/history").limitToLast(20);

// UI
const imgEl = document.getElementById("cameraImage");
const bboxEl = document.getElementById("bbox");
const confEl = document.getElementById("confidence");
const labelEl = document.getElementById("label");
const timeEl = document.getElementById("timestamp");
const historyListEl = document.getElementById("historyList");

function setStatus(ok){
    document.getElementById("statusConnected").classList.toggle("hidden", !ok);
    document.getElementById("statusWaiting").classList.toggle("hidden", ok);
}

// LIVE LISTENER
latestRef.on("value", snap=>{
    if(!snap.exists()) return setStatus(false);
    const d = snap.val(); setStatus(true);

    if(d.image_b64) imgEl.src="data:image/jpeg;base64,"+d.image_b64;
    labelEl.textContent = d.label;

    confEl.classList.remove("conf-green","conf-yellow","conf-red");
    const p=d.confidence;
    if(p>=0.85) confEl.classList.add("conf-red");
    else if(p>=0.6) confEl.classList.add("conf-yellow");
    else confEl.classList.add("conf-green");
    confEl.textContent = (p*100).toFixed(1)+"%";

    timeEl.textContent = new Date().toLocaleTimeString();

    bboxEl.style.left=d.x+"px";
    bboxEl.style.top=d.y+"px";
    bboxEl.style.width=d.width+"px";
    bboxEl.style.height=d.height+"px";
});

// CLEAR HISTORY
document.getElementById("clearHistoryBtn").onclick=()=>{
    if(confirm("Clear history?"))
        firebase.database().ref("detections/history").remove();
};

// =====================================
// CONFIDENCE TIME SERIES CHART
// =====================================
const confCtx = document.getElementById("confidenceChart").getContext("2d");
const confidenceChart = new Chart(confCtx,{
    type:"line",
    data:{ labels:[], datasets:[{
        label:"Confidence (%)",
        data:[],
        borderColor:"#58a6ff",
        backgroundColor:"rgba(88,166,255,0.25)",
        borderWidth:2,
        tension:0.22
    }]}
});

// =====================================
// PIE CHART
// =====================================
let diseaseCounts = {};

const pieCtx = document.getElementById("pieChart").getContext("2d");
const pieChart = new Chart(pieCtx,{
    type:"pie",
    data:{
        labels:[],
        datasets:[{
            data:[],
            backgroundColor:["#58a6ff","#1f6feb","#da3633","#d29922","#8b949e"],
            borderColor:"#0d1117",
            borderWidth:2
        }]
    },
    options:{ plugins:{ legend:{ labels:{ color:"#e6edf3" }}} }
});

// RESET PIE BUTTON
document.getElementById("resetPieBtn").onclick=()=>{
    if(!confirm("Reset pie chart counts?")) return;
    diseaseCounts = {};
    pieChart.data.labels = [];
    pieChart.data.datasets[0].data = [];
    pieChart.update();
};

// =====================================
// HISTORY LISTENER
// =====================================
historyRef.on("value", snap=>{
    historyListEl.innerHTML="";
    const timeLabels=[];
    const confValues=[];
    diseaseCounts={};

    if(!snap.exists()) return;

    snap.forEach(child=>{
        const d = child.val();

        // history UI
        const item=document.createElement("div");
        item.className="history-item";

        const img=document.createElement("img");
        img.className="history-thumb";
        img.src="data:image/jpeg;base64,"+d.image_b64;

        const meta=document.createElement("div");
        meta.innerHTML=`
            <div>${d.label}</div>
            <div>${(d.confidence*100).toFixed(1)}%</div>
        `;

        item.append(img,meta);
        historyListEl.appendChild(item);

        // line chart update
        timeLabels.push(new Date(d.timestamp).toLocaleTimeString());
        confValues.push((d.confidence*100).toFixed(1));

        // pie chart count
        diseaseCounts[d.label] = (d.label in diseaseCounts)
            ? diseaseCounts[d.label]+1
            : 1;
    });

    // update charts
    confidenceChart.data.labels = timeLabels;
    confidenceChart.data.datasets[0].data = confValues;
    confidenceChart.update();

    pieChart.data.labels = Object.keys(diseaseCounts);
    pieChart.data.datasets[0].data = Object.values(diseaseCounts);
    pieChart.update();
});
</script>

</body>
</html>
